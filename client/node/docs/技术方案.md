# MChat Node 客户端技术方案

> 与《技术设计方案》四、客户端设计及《消息交互接口与示例》对齐的 Node.js/TypeScript SDK 技术方案。

## 一、目标与范围

- **目标**：为 Node 环境提供 MChat 客户端 SDK，封装 MQTT 连接、请求-响应、收件箱/群消息订阅与事件，便于脚本、服务端或 CLI 集成。
- **范围**：连接与身份、请求-响应、收件箱与群消息接收、常用 action 封装（发消息、org.tree、config.storage 等）；不包含 UI、不负责历史消息持久化（由调用方自行落库）。

## 二、技术选型

| 项     | 选型           | 说明 |
|--------|----------------|------|
| 语言   | TypeScript     | 类型安全、与主技术方案一致，产出 .d.ts |
| 运行时 | Node.js >= 18  | 与 server 一致 |
| MQTT   | mqtt (mqtt.js) | 成熟、支持 TCP/WSS，与 admin 一致 |
| 构建   | tsc 输出 ESM+CJS | 或仅 ESM，便于被其他 Node 项目引用 |

## 三、连接与身份

### 3.1 连接信息来源

- 调用方传入 **连接选项**（与 `employee.create` 响应中的 `mqtt_connection` 一致）：
  - `brokerHost` / `brokerPort` / `useTls`
  - `username`（如 employee_id 或 Broker 用户名）/ `password`
  - 可选 `clientId`：不传则按 `client_id_scheme` 生成，格式 `{employee_id}_{device_id}_{uuid}`，保证单连接唯一。

### 3.2 连接参数

- 协议：`useTls ? 'mqtts' : 'mqtt'`，URL 为 `(mqtts|mqtt)://host:port`。
- 选项：`clientId`、`username`、`password`、`clean: false`（持久会话）、`reconnectPeriod`、可选 `keepalive`。
- **LWT**（Last Will）：主题 `mchat/status/{employee_id}`，payload `{ status: "offline", updated_at: ISO8601 }`，retain=true，便于服务端/其他端感知离线。

### 3.3 会话绑定

- 连接成功后**可选**调用 `auth.bind`：payload 含 `employee_id`（可与 username 一致），服务端写入 client_session，建立 client_id ↔ employee_id 映射。
- 若 Broker 已按 employee_id 认证，且服务端能从凭证解析 employee_id，可省略 auth.bind；否则建议连接后立即 auth.bind。

## 四、请求-响应

### 4.1 Topic 约定

- **请求**：发布到 `mchat/msg/req/{client_id}/{seq_id}`，payload JSON：`{ action, ...params }`，seq_id 仅放在 topic，payload 可不带。
- **响应**：订阅 `mchat/msg/resp/{client_id}/+`，响应发布到 `mchat/msg/resp/{client_id}/{seq_id}`，payload：`{ code, message, data }`。

### 4.2 实现要点

- **seq_id**：客户端生成（UUID 或短随机），保证未完成请求内唯一。
- **in-flight 映射**：`Map<seq_id, { resolve, reject, timeout }>`；收到响应时从 topic 取 seq_id，resolve(code, message, data)。
- **超时**：单次请求默认 30s，超时 reject；可配置。幂等 action 可由调用方重试。
- **顺序**：先订阅 `mchat/msg/resp/{client_id}/+`，再发请求，避免丢响应。

## 五、订阅与发布

### 5.1 必须订阅

- `mchat/msg/resp/{client_id}/+`：请求的响应。

### 5.2 按身份订阅

- `mchat/inbox/{employee_id}`：个人收件箱（单聊、系统通知等）。employee_id 在 auth.bind 或连接选项中确定。
- `mchat/group/{group_id}`：按已加入群列表订阅；加入新群时增加订阅，退群时取消（列表来自 org.tree 或本地缓存）。

### 5.3 可选订阅

- `mchat/status/+` 或 `mchat/status/{employee_id}`：在线状态。
- `mchat/profile/{employee_id}`：个人资料变更。
- `mchat/system/notify`：全局系统通知。

### 5.4 发布

- **在线状态**：连接成功后发布到 `mchat/status/{employee_id}`，payload `{ status: "online", updated_at: ISO8601 }`，retain=true；LWT 见 3.2。

## 六、API 设计（面向调用方）

### 6.1 类：MChatClient

- **构造**：`new MChatClient(options: MChatClientOptions)`，options 含 broker、username、password、employeeId、clientId?、deviceId? 等。
- **连接**：`async connect(): Promise<void>`，建立 MQTT、订阅 resp、可选 auth.bind、订阅 inbox、发布 online 状态。
- **断开**：`async disconnect(): Promise<void>`。
- **请求**：`async request<T>(action: string, params?: Record<string, unknown>): Promise<ApiResponse<T>>`，内部发 req、等 resp、超时/错误处理。

### 6.2 便捷方法（基于 request）

- `sendPrivateMessage(toEmployeeId, content, quoteMsgId?)`
- `sendGroupMessage(groupId, content, quoteMsgId?)`
- `getOrgTree()` / `getStorageConfig()` / `getAgentCapabilityList(skill?)` 等，按需封装。
- 群列表：调用方先 `request('org.tree')` 或后续扩展 `group.list`，再根据列表订阅 `mchat/group/{group_id}`；SDK 可提供 `subscribeGroup(groupId)` / `unsubscribeGroup(groupId)`。

### 6.3 事件

- **消息**：`on('inbox', (payload) => {})`、`on('group', (groupId, payload) => {})`，便于调用方落库或业务处理。
- **连接**：`on('connect')`、`on('offline')`、`on('error', err)`。
- **响应**：一般通过 request 的 Promise 返回即可；若有全局错误（如 401）可考虑事件。

## 七、错误与重试

- **错误码**：与接口文档一致（0 成功，400/401/403/404/429/500/504）；request 在 code !== 0 时 reject，带上 code、message、data。
- **重连**：mqtt.js 自带重连；重连后需重新订阅与（可选）重发 online 状态；in-flight 请求在断线时 reject。
- **重试**：SDK 不自动重试；调用方对幂等 action 自行重试。

## 八、与主技术方案对应关系

| 主方案章节     | 本实现                         |
|----------------|--------------------------------|
| 4.1 连接与身份 | §3 连接参数、client_id、auth.bind、LWT |
| 4.2 订阅列表   | §5 必须/按身份/可选订阅        |
| 4.3 发布行为   | §5.4 状态发布、§4 请求         |
| 4.4 响应关联与重试 | §4.2 in-flight、超时、§7 错误与重试 |

## 九、目录与构建

- **目录**：`client/node/`，src 下 `index.ts`、`client.ts`、`types.ts`，可选 `api.ts` 便捷方法。
- **构建**：`tsc` 输出到 `dist/`，package.json 的 main 指向 dist，types 指向 dist 的 .d.ts。
- **依赖**：仅 `mqtt`（及 @types/node、typescript 为 devDependencies）。
