# MChat 产品需求方案 — 评审纪要

---

## 一、总体评价

| 维度         | 评价 |
|--------------|------|
| 目标与定位   | 清晰：人机混合 IM + MQTT 唯一协议 + 三件套（Broker/服务端/客户端），与钉钉/飞书差异明确 |
| 结构完整性   | 较好：从目标、概述、核心功能、接口、非功能需求到优先级与 MVP 范围均有覆盖 |
| 可落地性     | 中等：接口与主题设计可指导实现，部分环节需在详细设计阶段补足（见下文） |

**结论**：方案可作为设计基线进入下一阶段（详细设计/原型），建议在开发前补齐以下缺口并统一若干约定。

---

## 二、优点

1. **产品目标与实现基石一致**  
   产品目标（人机混合聊天协作）与实现基石（MQTT 唯一协议、任意环境部署）相互支撑，没有冲突。

2. **7 大核心功能定义明确**  
   每个功能点都有「为什么是核心」和「MChat 关键实现」，MVP 边界清楚，验证标准（销售 Agent + 项目群协同）可验收。

3. **系统组成与职责清晰**  
   消息代理 / 服务端 / 客户端三者职责分离，且明确「仅 MQTT、无额外业务协议」，便于技术选型与分工。

4. **请求 topic 含身份 ID**  
   `mchat/msg/req/{client_id}/{seq_id}` 与响应对称，利于 ACL、鉴权与审计，设计合理。

5. **接口设计可直接指导开发**  
   管理类、消息类、状态与资料、扩展接口均有 topic + payload 说明，action 命名规范（如 `group.create`、`msg.send_private`），便于服务端路由与客户端封装。

6. **非功能需求覆盖关键维度**  
   可靠性、时延、安全合规、高可用、可观测均有提及，与「企业级」定位匹配。

---

## 三、一致性与缺口

### 3.1 主题体系与接口设计的对应关系

- **2.2.1** 中列出 `mchat/admin/cmd` 作为「管理指令」主题，但 **2.7 接口设计** 中管理类操作均走 `mchat/msg/req/{client_id}/{seq_id}`，未体现 `mchat/admin/cmd` 的用途。
- **建议**：在 PRD 中二选一或明确分工：  
  - 若管理操作统一走 req/resp，则说明 `mchat/admin/cmd` 为预留/可选（如仅用于服务端内部或运维指令）；  
  - 若管理操作部分走 `mchat/admin/cmd`，则在接口设计中补充对应 topic 与 payload。

### 3.2 client_id 与 employee_id 的约定

- 请求/响应 topic 使用 `client_id`，收件箱/状态使用 `employee_id`。多端登录时，同一员工可能对应多个 client_id，需在 PRD 中约定：
  - `client_id` 是否等于 MQTT ClientId（连接级），以及是否允许一员工多 client_id；
  - 服务端如何从 `client_id` 解析出 `employee_id`（映射表 / 登录时绑定）；
  - 订阅 `mchat/inbox/{employee_id}` 时，是否按 employee_id 订阅（多端同收）还是按 client_id 区分。
- **建议**：在 2.2 或 2.7 增加一小节「身份与连接模型」，明确 client_id / employee_id 含义、多端策略及订阅关系。

### 3.3 登录/认证与首次连接

- 当前 PRD 未描述：客户端如何完成「登录」、如何获得发布/订阅权限、Broker 的 ACL 如何与「员工/管理员」绑定。
- **建议**：在「安全与合规」或「接口设计」中补充：  
  - 认证方式（如证书 + 员工标识、或 Token 注入 client_id）；  
  - 首次连接后是否需通过某 MQTT 请求做「会话绑定」（如 `auth.bind`）；  
  - ACL 规则原则（例如：仅允许发布 `mchat/msg/req/{自身client_id}/+`、仅允许订阅 `mchat/msg/resp/{自身client_id}/+`、`mchat/inbox/{自身employee_id}` 等）。

### 3.4 服务端如何订阅请求主题

- 客户端发布到 `mchat/msg/req/{client_id}/{seq_id}`，服务端须订阅所有客户端的请求。若使用通配符，则为 `mchat/msg/req/+/+`。
- PRD 未写服务端订阅方式，Broker 需支持服务端订阅该通配符主题。
- **建议**：在 2.2.3 或技术约束中注明：服务端订阅 `mchat/msg/req/+/+`（或等价形式），Broker 需支持此类订阅。

### 3.5 错误码与重试

- 接口设计中有 `code`、`message`，但未定义错误码体系（如 0 成功，4xx 业务错误，5xx 服务端错误）及客户端重试策略。
- **建议**：在 2.7.1 或单独小节补充：  
  - 标准错误码区间与含义；  
  - 哪些 action 建议重试、哪些不重试（如幂等性说明）。

### 3.6 离线消息与历史拉取

- 非功能需求提到「离线消息重推」，但未说明：  
  - 拉取离线/历史消息的接口形式（是否通过 `mchat/msg/req` 的某 action，如 `msg.history_private` / `msg.history_group`）；  
  - 拉取范围（按会话、按时间、分页）。
- **建议**：在 2.7.3 或 2.4 中增加「离线/历史消息拉取」的 topic 与 payload 约定（至少 MVP 所需的最简形式）。

---

## 四、接口与协议

- **已读回执**：当前写为「发布到 `mchat/read_ack` 或 `mchat/msg/read_ack`」，若需按员工隔离，可考虑 `mchat/msg/read_ack/{employee_id}` 或 payload 内带 reader_employee_id，由服务端校验。
- **Agent 能力发现**：`mchat/agent/capability/{skill}` 与 req 中的 `agent.capability_list` 两种方式都写了，建议注明主推方式（如以请求-响应为主，topic 订阅为可选推送）。
- **content 类型**：消息类接口中 `content` 为 string 或 object，建议在 PRD 或后续数据模型里约定类型枚举（如 text / image / file）及 object 的必选字段，便于多端统一解析。

---

## 五、安全与合规

- 已覆盖：TLS、双向证书、ACL、审计、限流、敏感词。  
- 可补充：  
  - 消息是否端到端加密（E2EE）：若不做，明确为「传输与存储由服务端/平台保护」；若做，需约定密钥分发与 MQTT payload 加密方式。  
  - 敏感操作「二次验证」在纯 MQTT 下的实现思路（例如：敏感 action 需先请求 `auth.challenge`，再带 token 请求实际操作）。

---

## 六、可落地性与风险

| 风险点               | 说明与建议 |
|----------------------|------------|
| 服务端订阅与性能     | 服务端需订阅 `mchat/msg/req/+/+`，高并发下单点可能成为瓶颈；建议在架构中考虑水平扩展与共享订阅（如 EMQX 共享订阅）。 |
| AI 路由与超时        | Agent 通过 Webhook 回调时，15s 超时与 MQTT 请求-响应的等待时间需一致；若超时，响应中需明确返回「超时」类错误码，客户端可做重试或转人工。 |
| 多端与顺序           | 同一员工多端在线时，消息顺序、已读状态、离线拉取顺序需在详细设计中约定（如按 server 时间戳排序）。 |
| 大文件与 OSS         | 当前仅写「大文件走 OSS，MQTT 传元数据」，可补充：上传/下载是否仍通过 MQTT 某 action 获取临时 URL，还是通过其它通道（若坚持纯 MQTT，可用请求-响应返回 URL）。 |

---

## 七、改进建议汇总

1. **必补**  
   - 明确 `mchat/admin/cmd` 与 `mchat/msg/req` 管理类接口的关系或弃用说明。  
   - 增加「身份与连接模型」：client_id / employee_id、多端、订阅关系。  
   - 增加「认证与 ACL」：登录方式、ACL 原则、服务端订阅方式（如 `mchat/msg/req/+/+`）。  
   - 增加「离线/历史消息」的接口约定（topic + action + payload）。  
   - 统一错误码与重试建议。

2. **建议补**  
   - 消息 `content` 类型枚举与 object 结构。  
   - 端到端加密策略（做与否及范围）。  
   - 已读回执、Agent 能力发现的主推用法。

3. **可后续迭代**  
   - 详细错误码表、限流阈值、审计日志格式可在详细设计/技术方案中展开。

---

**评审结论**：方案结构完整、目标清晰、接口可实施，适合作为设计基线。建议在开发前按上述「必补」项补充后进入详细设计与原型开发，并在实现过程中把「建议补」项纳入技术方案或下一版 PRD 更新。
