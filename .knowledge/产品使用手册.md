# MChat 产品使用手册

> 面向管理员与员工的日常使用说明，配合《产品需求方案》与《技术设计方案》使用。  
> **文档版本**：1.0

---

## 一、手册说明

MChat 是一套**人机混合**的企业即时通讯系统：人类员工与 AI 数字员工（Agent）在同一套 IM 中聊天、协作。所有交互基于 **MQTT** 与**对象存储**，管理员负责组织与权限，员工通过客户端连接后即可单聊、群聊、与 AI 协作、上传下载文件。

本手册面向两类用户：

- **管理员**：注册员工（含 AI Agent）、创建与管理群组、维护组织架构、将 MQTT 连接信息交付员工。
- **员工**：使用 MQTT 连接信息登录客户端、收发消息、与 AI Agent 互动、获取对象存储配置并上传/下载文件。

---

## 二、管理员使用指南

### 2.1 前置条件

- 管理员本人已具备可用的 MChat 客户端（Web / 桌面 / 移动端或 SDK），并已使用自己的 MQTT 连接信息登录。
- 拥有**创建员工、创建群组、管理成员**等管理权限（具体权限范围以实际部署为准）。

### 2.2 注册员工（人类）

**目的**：将新同事加入组织，使其能够登录 MChat 客户端并参与沟通。

**步骤概要**：

1. 在管理端或客户端中发起**员工创建**（对应接口 `employee.create`）。
2. 填写必填信息：**姓名**（name）；可选：员工 ID（employee_id，不填则由系统生成）、部门（department_id）、上级（manager_id）等。
3. **不要**勾选「AI Agent」或 `is_ai_agent: false`（人类员工）。
4. 提交请求；等待响应。

**结果与后续**：

- 若成功（code=0），响应中的 **data** 会包含：
  - `employee_id`：该员工的唯一标识；
  - `name`、`created_at`；
  - **`mqtt_connection`**：该员工的 **MQTT 连接信息**（Broker 地址、端口、是否 TLS、以及 client_id 规则或用户名/密码/token）。
- **将 `mqtt_connection` 安全地交付给该员工**（如通过内部邮件、安全通道或线下告知），员工即可在 MChat 客户端中配置并登录，开始使用。

**注意**：同一员工可在多台设备/多个客户端登录（多端），每端使用各自的 client_id，均会收到该员工的收件箱与已加入群的消息。

### 2.3 注册 AI Agent（数字员工）

**目的**：将某个 AI 能力注册为「数字员工」，使其出现在组织架构与群聊中，可被 @ 或通过关键词触发。

**步骤概要**：

1. 发起**员工创建**，并勾选「AI Agent」或设置 `is_ai_agent: true`。
2. 填写 **agent_profile**（依客户端或接口要求）：
   - **capabilities**：能力列表（如「订单查询」「产品推荐」）；
   - **trigger_keywords**：触发关键词（如「查订单」「推荐产品」）；
   - **webhook_endpoint**：Agent 回调地址（服务端将把用户消息转发至该地址）；
   - **response_timeout**：超时时间（如 15 秒）；
   - 可选：model_type、auto_join_groups（自动加入的群 ID 列表）等。
3. 填写 name、department_id、manager_id 等与人类员工类似。
4. 提交请求。

**结果**：

- 成功后会返回 `employee_id`（即该 Agent 在组织内的 ID）、`name`、`created_at`，以及 **mqtt_connection**（若该 Agent 以「客户端」形态连接 Broker，则同样需要连接信息；否则仅需 employee_id 与 webhook 配置即可由服务端转发消息）。
- 该 Agent 会出现在组织架构与「可调用能力」列表中，员工在单聊或群聊中 @ 或发送关键词即可触发。

### 2.4 创建群组

**目的**：建立一个群聊，并指定初始成员（人类和/或 AI Agent）。

**步骤概要**：

1. 发起**创建群组**（`group.create`）。
2. 填写**群名称**（name）、**初始成员列表**（member_ids：多个 employee_id）。
3. 可选：群描述（description）、头像（avatar）等。
4. 提交请求。

**结果**：

- 成功时返回 `group_id`、`name`、`member_ids`、`created_at`。
- 系统会向每位成员收件箱投递**入群通知**（含 group_id、群名、邀请人等），成员客户端可据此展示「新群」并订阅该群主题，接收后续群消息。

### 2.5 管理群成员

- **添加成员**：使用 `group.member_add`，传入 `group_id` 和要加入的 `member_ids`（人类或 AI Agent 的 employee_id）。成功后新成员会收到入群通知，并可接收群消息。
- **移除成员**：使用 `group.member_remove`，传入 `group_id` 和要移除的 `member_ids`。
- **解散群组**：仅创建者或管理员可操作，使用 `group.dismiss`，传入 `group_id`。解散后该群不再可用。

### 2.6 查看与维护组织架构

- **获取组织树**：发起 `org.tree` 请求，可得到当前部门树（departments）与员工列表（employees，含 employee_id、name、department_id、manager_id、is_ai_agent 等）。用于管理端展示组织架构、或在客户端展示通讯录。
- **更新员工信息**：使用 `employee.update`，传入 `employee_id` 和要修改的字段（如 name、department_id、agent_profile 等）。变更后相关方可能收到个人资料变更通知（依实现而定）。

### 2.7 管理员操作小结

| 操作           | 说明 |
|----------------|------|
| 注册人类员工   | employee.create，成功后交付 **mqtt_connection** 给该员工用于登录 |
| 注册 AI Agent  | employee.create 且 is_ai_agent=true，配置 agent_profile（含 webhook、能力、关键词） |
| 创建群组       | group.create，填写群名与 member_ids |
| 添加/移除成员  | group.member_add / group.member_remove |
| 解散群组       | group.dismiss（需权限） |
| 组织架构       | org.tree 获取部门与员工列表；employee.update 更新员工信息 |

---

## 三、员工使用指南

### 3.1 首次使用：获得连接信息并登录

**前提**：管理员已为你创建账号，并**将 MQTT 连接信息（mqtt_connection）交付给你**。其中通常包含：

- Broker 地址（broker_host）、端口（broker_port）、是否 TLS（use_tls）；
- 连接凭证：client_id 规则，或 mqtt_username / mqtt_password（或 token）。

**步骤**：

1. 打开 MChat 客户端（Web / 桌面 / 移动端）。
2. 在「登录」或「配置」页中，填入上述 **MQTT 连接信息**（若客户端支持，可能以「扫码」或「链接」形式一键填入）。
3. 确认连接；客户端会使用该信息连接 MQTT Broker，并完成会话绑定（如 auth.bind）。
4. 登录成功后，你会看到自己的收件箱、已加入的群列表（若有）、以及组织架构/通讯录（依客户端实现）。

**多端登录**：你可以在手机和电脑上同时登录；每个设备会独立收消息，历史记录由各端本地保存（系统不提供云端历史拉取）。

### 3.2 收发单聊消息

- **发消息**：在会话中选择一位同事（或 AI Agent），输入内容后发送。客户端会通过 `msg.send_private` 将消息发往对方 employee_id；对方在其收件箱中会收到该条消息。
- **收消息**：你收到的单聊与系统通知都会出现在**收件箱**中；客户端会按本地逻辑展示会话列表与历史（历史由客户端本地存储）。

支持文本、图片、文件等类型；图片/文件会先上传到对象存储（见 3.5），消息中只带链接或元数据。

### 3.3 收发群聊消息

- **查看已加入的群**：通过组织架构或「群列表」进入某个群（group_id）。
- **发群消息**：在群内输入内容并发送；客户端会通过 `msg.send_group` 发送到该 group_id，群内所有成员都会收到。
- **收群消息**：只要你在该群成员列表中，该群的新消息会推送到你的客户端；同样，群内历史由客户端本地保存与展示。

可在群内 @ 指定成员（人类或 AI Agent），或输入关键词触发 AI Agent（见 3.4）。

### 3.4 与 AI Agent 协作

- **查看可用 Agent**：在客户端中可查看「可调用能力」或 Agent 列表（对应 `agent.capability_list`），了解有哪些数字员工及其能力（如「订单查询」「产品推荐」）。
- **单聊中与 Agent 对话**：在单聊中选择某个 AI Agent 为会话对象，直接发送问题或指令；服务端会将消息转发给该 Agent 的 webhook，Agent 回复后会投递回你的收件箱。
- **群聊中 @ Agent**：在群内 @ 某 AI Agent（如 @报销机器人），或发送其配置的**触发关键词**（如「查订单」），服务端会识别并路由到对应 Agent；回复会发到群内，全员可见。
- **转人工**：若 Agent 无法解决或超时，可发送「转人工」或按客户端提示操作，会话可转交指定人类员工继续处理。

### 3.5 获取对象存储配置并上传/下载文件

**目的**：在发图片、发文件或查看他人发的文件时，需要能够**上传到对象存储**或**从对象存储下载**。系统通过「对象存储读写配置」让你在客户端直接读写，无需经服务端中转文件内容。

**步骤**：

1. 确保已**登录 MQTT**（见 3.1）。
2. 在客户端中触发「获取存储配置」或「刷新存储配置」（对应 `config.storage` 请求）。客户端会向服务端请求当前账号的对象存储读写配置。
3. 服务端校验身份后，返回配置（如 endpoint、bucket、区域、临时凭证或预签名策略及过期时间）。
4. 客户端使用该配置初始化 S3 兼容 SDK 或直接发起上传/下载：
   - **上传**：你选择图片或文件后，客户端按配置直传对象存储，得到 URL 或 key，再通过 `msg.send_private` / `msg.send_group` 把该链接或元数据发给对方或群。
   - **下载**：收到带文件/图片链接的消息时，客户端按配置从对象存储直接下载并展示。

**说明**：配置通常有时效（如 expires_at）；过期后需再次请求 `config.storage` 获取新配置。部分实现也可能提供「按次临时 URL」（如 `file.upload_url` / `file.download_url`），用于单次上传或下载，可依客户端设计二选一或并存。

### 3.6 查看组织架构与同事状态

- **组织架构**：在「通讯录」或「组织」页可查看部门树和员工列表（含人类与 AI Agent），数据来自 `org.tree`。
- **在线状态**：若客户端展示在线/离线，则来自各员工的 `mchat/status/{employee_id}` 状态（LWT）；你上线后会发布自己的在线状态，断线后系统会标记为离线。

### 3.7 员工操作小结

| 操作             | 说明 |
|------------------|------|
| 首次登录         | 使用管理员下发的 **mqtt_connection** 在客户端配置并连接 |
| 单聊             | 选择对象后发送消息；收件箱收单聊与系统通知，历史本地保存 |
| 群聊             | 在已加入的群中发送/接收消息；可 @ 成员或发关键词触发 Agent |
| 与 AI 协作       | 单聊选 Agent 或群内 @/关键词；必要时「转人工」 |
| 文件/图片        | 先通过 **config.storage** 获取对象存储配置，再直传/直下；消息中只带链接或元数据 |
| 组织与状态       | org.tree 看架构；状态来自 status 主题 |

---

## 四、典型场景

### 4.1 新员工入职：从注册到首次登录

1. **管理员**：在管理端执行「注册员工」，填写新员工姓名、部门等，不勾选 AI Agent。提交后获得响应，其中包含该员工的 **mqtt_connection**。
2. **管理员**：将 mqtt_connection（或客户端登录链接/二维码）通过公司安全渠道发给新员工。
3. **新员工**：打开 MChat 客户端，填入或扫描下发的连接信息，完成 MQTT 连接与登录。
4. **新员工**：在客户端中请求「获取对象存储配置」（config.storage），之后即可在单聊/群聊中发送图片与文件。
5. **新员工**：在通讯录或组织架构中看到同事与群组，可发起单聊或进入已有群参与讨论。

### 4.2 创建项目群并邀请成员与 AI Agent

1. **管理员**：执行「创建群组」，输入群名（如「XX 项目组」）和初始成员 employee_id 列表（可包含人类员工和已注册的 AI Agent）。
2. 系统创建群组并向每位成员收件箱推送入群通知。
3. **成员**：在客户端看到新群，进入后即可收发群消息。
4. **成员**：在群内 @ 某 AI Agent（如「@销售小助 查一下订单状态」），Agent 回复会出现在群内，便于项目组共享信息。

### 4.3 员工向 AI Agent 查订单并转人工

1. **员工**：在单聊中选择「销售 AI」或群内 @ 销售 Agent，发送「查订单 12345」。
2. 服务端识别关键词或 @，将消息转发至该 Agent 的 webhook；Agent 查询后回复订单状态，消息投递回单聊或群。
3. 若 Agent 超时或回复「需要人工处理」，**员工**发送「转人工」或点击客户端「转人工」；会话可转交指定人类客服，由人类继续跟进。

### 4.4 员工在群内发送图片/文件

1. **员工**：已登录且曾获取过对象存储配置（或此时请求一次 config.storage）。
2. 在群聊中选择「发送图片」或「发送文件」，客户端使用当前存储配置**直接上传**到对象存储，得到 URL。
3. 客户端通过 `msg.send_group` 发送一条消息，content 为图片/文件类型，body 中含 url、name、size 等。
4. **其他成员**：收到该条群消息后，客户端根据 content 中的 url 与自身存储配置**直接下载**并展示图片或提供文件下载。

### 4.5 管理员维护组织架构与 Agent 能力

1. **管理员**：通过 `org.tree` 查看当前部门与员工列表，在管理端调整部门或汇报关系（依实现可能为 employee.update 或管理后台操作）。
2. **管理员**：为某 AI Agent 更新能力或关键词（employee.update，更新 agent_profile），保存后该 Agent 的「可调用能力」对员工侧可见的会随之更新。
3. **员工**：在「可调用能力」或 Agent 列表中看到更新后的技能说明，便于正确 @ 或使用关键词触发。

---

## 五、常见问题（FAQ）

**Q：员工忘记或丢失 MQTT 连接信息怎么办？**  
A：需由管理员或运维从系统侧重新获取或重置该员工的 MQTT 凭证（依实现可能为重新下发 mqtt_connection 或重置密码/token），再安全交付给员工重新配置客户端。

**Q：历史消息能拉取吗？**  
A：系统**不存储**消息历史，不提供历史拉取接口。各端看到的历史由**该端本地保存**；换设备或重装后，仅能看到重新登录后收到的新消息。

**Q：离线期间别人发我的消息会丢吗？**  
A：取决于 Broker 与客户端的持久会话与保留策略。若 Broker 未保留你离线期间的收件箱投递，则那段期间发给你的消息无法补发；你重连后只能收到新消息。重要内容建议对方在你上线后重发或通过其他渠道确认。

**Q：对象存储配置过期怎么办？**  
A：再次在客户端中触发「获取存储配置」（config.storage），拿到新配置后客户端会刷新上传/下载能力；无需重新登录 MQTT。

**Q：如何区分人类同事和 AI Agent？**  
A：在组织架构或会话列表中，AI Agent 通常有单独标识（如「数字员工」、技能标签）；在「可调用能力」列表中也会列出各 Agent 及对应技能，便于选择或 @。

---

## 六、文档与更新

- 本手册与《产品需求方案（PRD）v1.2》及《技术设计方案》保持一致；若产品有新增能力或流程变更，以最新 PRD 与实现为准。
- 具体客户端界面与操作入口以实际发布的 Web/桌面/移动端为准，本手册仅描述通用能力与典型步骤。
