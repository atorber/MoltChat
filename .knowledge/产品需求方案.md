# MChat 产品需求方案（PRD）v1.1

> 基于讨论整理，面向「人机共生」企业 IM 的完整需求与设计基线。  
> **文档版本**：1.1（根据评审纪要修订）

---

## 产品目标

**设计一个 IM 系统，使人类成员与 AI Agent 成员可以在同一套 IM 中混合存在，进行聊天、沟通与协作。**

- 人类与 AI Agent 拥有统一的会话与群组，可单聊、可群聊、可@指定对象。
- AI Agent 以「数字同事」身份参与沟通，可被召唤、可主动推送、可参与工作流。
- 系统为人机混合协作提供身份、消息、组织与安全基座，而非仅把 AI 当作外挂工具。

---

## 一、产品概述

### 1.1 产品定位

MChat 是实现上述目标的**企业级即时通讯系统**：以 **MQTT 为唯一交互协议**，以 **人类与 AI Agent 混合组织** 为核心。设计哲学：不止于「让 AI 能聊天」，而是构建 **人机共生的数字组织基座**——每个 AI Agent 是具备明确职责、可被管理、可协作的「数字同事」。

### 1.2 实现基石：MQTT 唯一协议与任意环境部署

**系统的实现基石是 MQTT 协议。** 消息收发、管理操作（建群、配置 Agent、组织架构等）**完全使用 MQTT 作为交互协议**，不引入 HTTP/WebSocket 等额外业务协议。

由此带来的约束与收益：

- **协议统一**：客户端与服务端仅需实现 MQTT 连接与主题订阅/发布，即可完成所有消息与管理接口的交互。
- **环境无关**：客户端和服务端均可部署在**任意环境**——个人电脑、各类终端、机房或云上的服务器，只要具备 MQTT 客户端/服务端能力即可接入，无需依赖特定运行时或浏览器环境。
- **实现灵活**：同一套主题与报文规范下，可用不同语言、不同平台实现多端（桌面、CLI、无头服务等），便于在现有基础设施上集成或扩展。

### 1.3 目标用户

- **企业管理员**：组织架构与数字员工配置、审计与治理
- **人类员工**：与同事及 AI Agent 的日常沟通与协作
- **开发者/运维**：集成、扩展与运维 IM 与 Agent 能力

### 1.4 系统组成：服务端、客户端、消息代理（MQTT Broker）

系统由**服务端**、**客户端**、**消息代理（MQTT Broker）** 三部分组成。客户端与服务端均以 MQTT 客户端身份连接至同一 Broker，通过主题订阅与发布完成消息与管理接口的交互。

| 组件     | 职责与形态 |
|----------|------------|
| **消息代理（MQTT Broker）** | 标准 MQTT 消息中转：接收发布、按主题投递、维护会话与 QoS。不承载业务逻辑，仅负责消息路由与（可选）持久化。可选用 EMQX、AWS IoT Core 等，部署在机房或云上。 |
| **服务端** | 负责**管理侧**能力：员工（含人类与 AI Agent）的增删改、组织架构与汇报关系、权限配置、群组创建与成员管理、组织结构维护等；同时作为 MQTT 网关与业务中继，订阅请求主题、验证权限、路由消息、维护状态与持久化，并发布至相应主题。通常部署在机房或云上服务器。 |
| **客户端** | 即**员工侧**使用入口，形态包括：**SDK**（供业务系统或脚本集成）、**Android / iOS 原生应用**、**Web 端**等。员工（人类或 AI Agent 的宿主）通过客户端连接 Broker、收发消息、接收管理通知，所有交互均基于 MQTT 主题与报文，与具体端形态无关。 |

管理员可通过带管理权限的客户端或专用管理端连接同一 Broker 与服务端，执行组织、权限、群组等管理操作。

### 1.5 与钉钉/飞书差异化

| 维度         | 传统 IM（钉钉/飞书）   | MChat（AI Agent 优化）           |
|--------------|------------------------|----------------------------------|
| 身份本质     | 人类员工               | 人类 + AI 数字员工混合组织       |
| 消息价值     | 沟通记录               | 可触发自动化工作流               |
| 组织动态     | 静态架构               | AI Agent 按技能动态加入项目群    |
| 管理焦点     | 人员管理               | 人机协作效能优化                 |

---

## 二、核心功能需求

### 2.1 不可妥协的 7 大核心功能（MVP 基线）

定义：缺失任一，系统即失去「即时通信」本质或无法支撑企业级人机协作场景。

| 序号 | 功能点             | 为什么是核心                         | MChat 关键实现要点                                   |
|------|--------------------|--------------------------------------|------------------------------------------------------|
| 1    | 统一数字身份体系   | 人类与 AI 必须拥有平等、可管理的组织身份 | 员工 ID = AI Agent ID，含部门/汇报关系/技能标签，服务端统一注册 |
| 2    | 可靠消息收发中枢   | IM 的存续根基：消息不丢、不乱、可达   | MQTT QoS=1 + 服务端持久化队列，离线消息重推，端到端 ACK |
| 3    | 组织架构治理       | 企业 IM 的灵魂：消息流转依赖组织关系 | 可视化部门树、汇报链配置，权限与架构强绑定           |
| 4    | 人机双向通信       | MChat 差异化命脉：AI 是「同事」非工具 | 人类 @AI 触发技能；AI 主动推送任务/预警；上下文透传   |
| 5    | 混合群组协作       | 现代工作流载体：人与 AI 共处同一战场 | 群内含人类 + 多 Agent，消息智能路由（如 @报销机器人） |
| 6    | 基础管理闭环       | 系统可持续运营前提                   | 管理员端：增删成员/配置 Agent/建群/审计日志（最小管理集） |
| 7    | 安全合规基线       | 企业采用的准入门槛                   | 传输加密 + 认证鉴权 + 操作留痕，满足等保基础要求     |

**验证标准**：若系统仅保留以上 7 点，仍能支撑「人类员工向销售 AI Agent 提问订单状态，并在项目群中协同处理」的核心业务流 → 即为合格 MVP。

**一句话总结**：身份是根，消息是脉，组织是骨，人机协同是魂 —— 其余皆为枝叶。

---

### 2.2 通信基石层（MQTT 协议与主题体系）

#### 2.2.1 主题（Topic）体系

**身份与状态**

- `mchat/status/{employee_id}` — LWT 在线状态（retain=true）
- `mchat/profile/{employee_id}` — 个人资料变更通知

**消息路由（服务端中枢模式）**

- `mchat/msg/req/{client_id}/{seq_id}` — 客户端 → 服务端：所有操作请求（含聊天/管理）；**topic 中包含发布者身份 `client_id`**，便于 Broker ACL（仅允许向自身前缀发布）、服务端鉴权与审计
- `mchat/msg/resp/{client_id}/{seq_id}` — 服务端 → 客户端：操作响应（与请求的 `client_id` 一致，便于订阅）
- `mchat/inbox/{employee_id}` — 个人消息收件箱（服务端转发后投递）
- `mchat/group/{group_id}` — 群聊消息通道（服务端验证后广播）

**管理指令与系统通知**

- **管理类操作**（创建群/调部门、员工/权限/组织等）**统一走请求-响应**：客户端发布到 `mchat/msg/req/{client_id}/{seq_id}`，服务端响应到 `mchat/msg/resp/{client_id}/{seq_id}`。不在单独的管理 topic 上做业务接口。
- `mchat/admin/cmd` — **预留/可选**：仅用于服务端内部或运维脚本下发的管理指令（如批量同步、配置热更），不面向普通客户端；若未使用可留空。
- `mchat/system/notify` — 全局系统通知（新员工加入等）

#### 2.2.2 身份与连接模型（client_id 与 employee_id）

- **employee_id**：业务身份，唯一标识一名员工（人类或 AI Agent），用于收件箱、状态、组织架构等。一人/一 Agent 对应一个 employee_id。
- **client_id**：连接级身份，与 MQTT 连接绑定。**约定**：连接时由客户端使用（如 MQTT ClientId 或登录后服务端下发的会话 ID），且与当前登录的 employee_id 可映射。**允许多端**：同一 employee_id 可对应多个 client_id（多设备/多端同时在线），每个连接一个 client_id。
- **映射与订阅**：
  - 服务端在登录/会话绑定时维护 `client_id → employee_id` 映射，请求鉴权时从 topic 的 client_id 解析出 employee_id。
  - 客户端订阅收件箱时按**员工身份**订阅：`mchat/inbox/{employee_id}`，同一员工多端会同时收到同一份收件箱消息；群消息按 `mchat/group/{group_id}` 订阅。
- **多端顺序**：消息顺序以服务端时间为准；同一员工多端收到的离线/历史拉取顺序一致（如按 `sent_at` 升序分页）。

#### 2.2.3 请求-响应与 QoS

- **请求-响应**：所有操作携带唯一 `seq_id`，客户端订阅专属响应主题，实现同步交互。
- **QoS 策略**：聊天消息 QoS=1（可靠投递），状态更新 QoS=0（实时优先），关键管理操作 QoS=2。
- **Broker 选型**：推荐 EMQX Cloud / AWS IoT Core，支持 ACL 动态授权、共享订阅、消息持久化。

#### 2.2.4 服务端核心职责与订阅方式

- **MQTT 网关**：统一接收/验证/路由所有 MQTT 消息。**服务端订阅方式**：服务端须订阅客户端请求主题以接收所有请求，使用通配符 **`mchat/msg/req/+/+`**（或 Broker 等价形式）。Broker 需支持服务端对该主题的订阅；高并发场景建议使用 **共享订阅**（如 EMQX `$share/group/gateway/mchat/msg/req/+/+`）做水平扩展。
- **状态中枢**：维护组织架构、在线状态、会话关系（内存 + DB 双写），维护 client_id ↔ employee_id 映射。
- **消息中继**：验证权限后转发消息至目标收件箱，同时持久化至时序数据库（如 TDengine）
- **离线处理**：利用 MQTT 持久会话 + 服务端消息队列，客户端重连后补推离线消息

---

### 2.3 AI Agent 数字身份与能力

#### 2.3.1 员工模型扩展（含 AI Agent）

```json
{
  "employee_id": "ai_sales_001",
  "is_ai_agent": true,
  "agent_profile": {
    "model_type": "LLM-v3",
    "capabilities": ["订单查询", "产品推荐", "会议安排"],
    "trigger_keywords": ["查订单", "推荐产品"],
    "webhook_endpoint": "https://agent.example.com/callback",
    "response_timeout": 15,
    "auto_join_groups": ["sales_team"]
  },
  "department_id": "dept_sales",
  "manager_id": "human_mgr_001",
  "skills_badge": ["⚡实时响应", "📊数据解读"]
}
```

#### 2.3.2 AI Agent 专属能力

- **智能路由**：消息含 @ 或技能关键词时，自动路由至对应 AI Agent
- **上下文感知**：服务端为 AI Agent 附加会话上下文（历史若干条消息 + 用户画像）
- **主动服务**：支持定时任务触发（如每日 9:00 推送销售简报）
- **能力市场**：管理员在后台配置 Agent 技能卡片，员工在聊天界面可查看「可调用能力」
- **人机协作**：支持「转人工」指令，消息无缝流转至指定人类员工

---

### 2.4 关键业务流程

#### 2.4.1 创建群聊流程

1. 管理员客户端发布 JSON 到 `mchat/msg/req/{client_id}/{seq_id}`（client_id 为当前连接的身份 ID）
2. 服务端验证权限 → 创建群组 → 持久化 → 发布响应到 `mchat/msg/resp/{client_id}/{seq_id}`
3. 服务端向全体成员发布系统通知至各自 `mchat/inbox/{employee_id}`，含群 ID 与加入指引

#### 2.4.2 AI Agent 消息处理流

- 用户消息 → 服务端识别意图/关键词 → 路由至对应 Agent（Webhook 或内部引擎）
- 服务端为 Agent 附加上下文（历史消息 + 用户画像）
- Agent 响应经服务端校验与限流后，投递至用户收件箱或群聊
- 支持多 Agent 接力（如 `next_agent: "finance_bot"`）及人类审批节点

---

### 2.5 消息与体验增强（扩展）

- **已读回执**：接收方发布 `read_ack` 至专用主题
- **消息引用**：payload 含 `quote_msg_id`
- **富媒体**：大文件走 OSS，MQTT 仅传加密元数据 + 临时链接
- **组织架构可视化**：客户端通过 `mchat/org/tree` 主题拉取实时组织树（JSON）

---

### 2.6 企业级治理与运维

- **管理后台**：组织架构拖拽调整、批量导入导出、权限模板、Agent 技能配置
- **审计合规**：操作日志留存（如 180 天+）、敏感操作二次验证、司法取证与归档
- **集成生态**：OpenAPI（用户/消息/群组）、Webhook 事件、SSO 对接
- **数据驾驶舱**：活跃度/留存率/消息量可视化、异常行为预警

---

### 2.7 接口设计

以下为基于 MQTT 主题与 JSON payload 的接口约定。**请求类**接口：客户端向请求主题发布，并订阅自身响应主题接收结果；**服务端推送类**：客户端订阅相应主题接收消息或通知。Payload 均为 JSON，编码 UTF-8。

#### 2.7.1 通用请求-响应约定

- **请求**：客户端发布到 `mchat/msg/req/{client_id}/{seq_id}`，其中 `client_id` 为发布者自身连接身份（见 2.2.2），同一请求内 `seq_id` 唯一，用于关联响应。topic 含身份便于 Broker ACL 与审计。
- **响应**：服务端发布到 `mchat/msg/resp/{client_id}/{seq_id}`，客户端需订阅 `mchat/msg/resp/{client_id}/+` 接收属于自己的响应。
- **QoS**：请求/响应建议 QoS=1；关键管理操作可用 QoS=2。

**错误码与重试**：

- **响应**中 `code`：`0` 表示成功，非 0 表示失败。建议区间：`0` 成功；`4xx` 业务错误（如 400 参数错误、403 无权限、404 资源不存在、429 限流）；`5xx` 服务端错误（如 500 内部错误、504 超时）。
- **重试**：对 **幂等** 的 action（如 `org.tree`、`msg.history_private`、`msg.history_group`）可在超时或 5xx 时重试；对 **非幂等** 的 action（如 `msg.send_private`、`msg.send_group`、`group.create`）不建议自动重试，由业务层根据 `code` 与 `message` 决定是否重试或提示用户。Agent 调用超时（如 504）时，客户端可提示「转人工」或稍后重试。

---

#### 2.7.2 管理类接口（请求-响应）

| 接口名称 | 接口描述 | Topic（发布/订阅） | Payload 说明 |
|----------|----------|--------------------|--------------|
| **创建群组** | 管理员或授权用户创建群聊，指定群名与初始成员 | 请求：发布到 `mchat/msg/req/{client_id}/{seq_id}`<br>响应：订阅 `mchat/msg/resp/{client_id}/{seq_id}` | **请求**：<br>`action`: `"group.create"`<br>`seq_id`:  string，本次请求唯一序号<br>`name`: string，群名称<br>`member_ids`: string[]，初始成员 employee_id 列表<br>`opts`: object 可选，如 `description`、`avatar` 等<br>**响应**：<br>`seq_id`: 与请求一致<br>`code`: number，0 成功，非 0 错误码<br>`message`: string，提示信息<br>`data`: object，成功时含 `group_id`（string）、`name`、`member_ids`、`created_at`（ISO8601） |
| **解散群组** | 解散指定群组，仅管理员或创建者可操作 | 同上 | **请求**：<br>`action`: `"group.dismiss"`<br>`seq_id`: string<br>`group_id`: string<br>**响应**：<br>`seq_id`, `code`, `message`；成功时 `data` 可含 `group_id`, `dismissed_at` |
| **添加群成员** | 向已有群组添加成员（人类或 AI Agent） | 同上 | **请求**：<br>`action`: `"group.member_add"`<br>`seq_id`: string<br>`group_id`: string<br>`member_ids`: string[]<br>**响应**：<br>`seq_id`, `code`, `message`；成功时 `data` 含 `group_id`, `added_ids`, `current_member_count` |
| **移除群成员** | 从群组移除指定成员 | 同上 | **请求**：<br>`action`: `"group.member_remove"`<br>`seq_id`: string<br>`group_id`: string<br>`member_ids`: string[]<br>**响应**：同上结构 |
| **员工创建/注册** | 创建人类员工或注册 AI Agent 为数字员工 | 同上 | **请求**：<br>`action`: `"employee.create"`<br>`seq_id`: string<br>`employee_id`: string 可选，不填则服务端生成<br>`name`: string<br>`is_ai_agent`: boolean<br>`department_id`: string 可选<br>`manager_id`: string 可选<br>`agent_profile`: object 可选，仅当 `is_ai_agent=true` 时；含 `model_type`,`capabilities`,`trigger_keywords`,`webhook_endpoint`,`response_timeout`,`auto_join_groups` 等<br>**响应**：<br>`seq_id`, `code`, `message`；成功时 `data` 含 `employee_id`, `name`, `created_at` |
| **员工更新** | 更新员工资料或 Agent 配置 | 同上 | **请求**：<br>`action`: `"employee.update"`<br>`seq_id`: string<br>`employee_id`: string<br>`updates`: object，要更新的字段（如 `name`,`department_id`,`agent_profile` 等）<br>**响应**：标准响应，成功时 `data` 含更新后摘要 |
| **组织架构获取** | 获取当前组织树（部门、汇报关系、成员列表） | 请求：发布到 `mchat/msg/req/{client_id}/{seq_id}`<br>或 订阅 `mchat/org/tree` 接收服务端定期/按需推送 | **请求**：<br>`action`: `"org.tree"`<br>`seq_id`: string<br>**响应**：<br>`seq_id`, `code`, `message`；成功时 `data` 含 `departments`（树形）、`employees`（列表，含 `employee_id`,`name`,`department_id`,`manager_id`,`is_ai_agent` 等） |

---

#### 2.7.3 消息类接口（请求-响应 + 投递）

**消息 content 类型**：`content` 可为 string（纯文本）或 object。object 时建议统一结构：`type`: 枚举（见下表），`body`: 内容。多端据此统一解析。

| type     | 说明     | body 示例 |
|----------|----------|-----------|
| `text`   | 纯文本   | string 或 `{"text": "..."}` |
| `image`  | 图片     | `{"url": "https://...", "width", "height"}`（或 OSS 临时链接） |
| `file`   | 文件     | `{"url": "...", "name", "size"}`（大文件走 OSS，MQTT 仅传元数据） |

| 接口名称 | 接口描述 | Topic（发布/订阅） | Payload 说明 |
|----------|----------|--------------------|--------------|
| **发送单聊消息** | 向指定员工发送私聊消息，服务端校验权限后投递到对方收件箱 | 请求：发布到 `mchat/msg/req/{client_id}/{seq_id}`<br>响应：订阅 `mchat/msg/resp/{client_id}/{seq_id}` | **请求**：<br>`action`: `"msg.send_private"`<br>`seq_id`: string<br>`to_employee_id`: string<br>`content`: string 或 object（见上 type/body）<br>`quote_msg_id`: string 可选<br>**响应**：<br>`seq_id`, `code`, `message`；成功时 `data` 含 `msg_id`, `to_employee_id`, `sent_at`（ISO8601） |
| **发送群聊消息** | 向指定群组发送消息，服务端校验群成员后广播到群主题 | 同上 | **请求**：<br>`action`: `"msg.send_group"`<br>`seq_id`, `group_id`, `content`, `quote_msg_id` 可选<br>**响应**：成功时 `data` 含 `msg_id`, `group_id`, `sent_at` |
| **拉取单聊历史/离线** | 按会话拉取与某员工的单聊历史或离线消息，分页 | 请求：发布到 `mchat/msg/req/{client_id}/{seq_id}`<br>响应：订阅 `mchat/msg/resp/{client_id}/{seq_id}` | **请求**：<br>`action`: `"msg.history_private"`<br>`seq_id`: string<br>`peer_employee_id`: string，对方员工 ID<br>`before_msg_id`: string 可选，从此消息之前拉取；不传则拉取最新<br>`limit`: number 可选，默认 20，最大建议 100<br>**响应**：成功时 `data` 含 `messages`: array（按 `sent_at` 升序），每项含 `msg_id`,`from_employee_id`,`to_employee_id`,`content`,`sent_at`；`has_more`: boolean |
| **拉取群聊历史/离线** | 按群拉取历史或离线消息，分页 | 同上 | **请求**：<br>`action`: `"msg.history_group"`<br>`seq_id`: string<br>`group_id`: string<br>`before_msg_id`: string 可选<br>`limit`: number 可选<br>**响应**：成功时 `data` 含 `messages`（含 `msg_id`,`group_id`,`from_employee_id`,`content`,`sent_at`）、`has_more` |
| **接收个人消息（收件箱）** | 服务端将单聊消息、系统通知等投递到员工收件箱 | 订阅 `mchat/inbox/{employee_id}` | **Payload（服务端 → 客户端）**：<br>`msg_id`, `type`（如 `private`,`system`,`agent`）, `from_employee_id` 可选, `content`（string 或 type/body object）, `sent_at`, `quote_msg_id` 可选；系统类可含 `action`, `group_id`, `inviter_id` 等 |
| **接收群消息** | 服务端将群聊消息广播到群主题，成员订阅该群即可收消息 | 订阅 `mchat/group/{group_id}` | **Payload（服务端 → 客户端）**：<br>`msg_id`, `group_id`, `from_employee_id`, `content`, `sent_at`, `quote_msg_id` 可选；可选 `read_count`, `is_ai_agent` 等 |

---

#### 2.7.4 状态与资料（服务端推送 / 客户端发布）

| 接口名称 | 接口描述 | Topic（发布/订阅） | Payload 说明 |
|----------|----------|--------------------|--------------|
| **在线状态（LWT）** | 客户端连接时发布在线，断线时 Broker 通过 LWT 发布离线；retain 便于新订阅者获取最新状态 | 发布/订阅 `mchat/status/{employee_id}`，retain=true | **Payload**：<br>`status`: `"online"` \| `"offline"`<br>`updated_at`: string，ISO8601<br>可选 `device`, `client_id` |
| **个人资料变更通知** | 员工或 Agent 资料变更后，服务端通知相关方 | 订阅 `mchat/profile/{employee_id}` | **Payload（服务端 → 客户端）**：<br>`employee_id`: string<br>`event`: `"updated"`<br>`fields`: string[]，变更字段名<br>`profile`: object，当前资料摘要（如 `name`,`department_id`,`is_ai_agent`,`skills_badge`）<br>`updated_at`: string |
| **系统通知** | 全局或批量系统通知（如新员工加入、权限变更、公告） | 订阅 `mchat/system/notify` 或 投递到各自 `mchat/inbox/{employee_id}` | **Payload**：<br>`notify_id`: string<br>`type`: string，如 `"announce"`,`"member_joined"`,`"permission_change"`<br>`title`: string 可选<br>`body`: string 或 object<br>`created_at`: string<br>可选 `target_employee_ids`、`group_id` 等 |

---

#### 2.7.5 扩展与可选

| 接口名称 | 接口描述 | Topic | Payload 说明 |
|----------|----------|-------|--------------|
| **已读回执** | 接收方确认已读某条消息；按员工隔离，由服务端校验 | 发布到 `mchat/msg/req/{client_id}/{seq_id}`（action 见下）或 专用主题 `mchat/msg/read_ack`，payload 内带 `reader_employee_id` 由服务端校验 | **请求-响应方式**：`action`: `"msg.read_ack"`，payload 含 `msg_id`, `conversation_type`（`private`/`group`）, `peer_employee_id` 或 `group_id`；**或** 直接发布到 `mchat/msg/read_ack`，payload：`msg_id`, `reader_employee_id`, `read_at`（ISO8601）, 可选 `group_id` |
| **Agent 能力发现** | 查询某技能对应的 Agent 列表；**主推请求-响应**，topic 订阅为可选推送 | **主推**：通过 `mchat/msg/req/{client_id}/{seq_id}` 请求 `action: "agent.capability_list"`，payload 可选 `skill`（不传则返回全部）；响应 `data` 含 `skill`, `agent_ids`, `agent_profiles` 等。**可选**：订阅 `mchat/agent/capability/{skill}` 接收服务端主动推送的能力变更 |

---

**说明**：客户端发布请求时**必须在 topic 中携带自身身份**，即使用 `mchat/msg/req/{client_id}/{seq_id}`，与响应 topic 对称；payload 均需包含 `action` 与 `seq_id`，其余参数依上表。服务端需校验 topic 中的 `client_id` 与连接/登录身份一致，并在 `mchat/msg/resp/{client_id}/{seq_id}` 返回统一结构的响应（`code`、`message`、`data`）。

---

## 三、非功能需求

### 3.1 通信可靠性与时延

- 消息到达率 ≥ 99.99%，断网重连自动续传
- 端到端延迟 &lt; 200ms（95 分位）
- 离线队列与多端同步，保证消息不丢、不乱、可达

### 3.2 安全与合规

- **连接安全**：TLS 1.3 + 双向证书认证（员工凭证由服务端注册时生成），或基于 Token 的认证（连接时携带，Broker 或服务端校验）。
- **认证与首次连接**：客户端连接 Broker 时使用服务端预先下发的凭证（如证书 + employee_id 注入、或 MQTT 用户名/密码对应一名员工）。**会话绑定**：可选地，连接后通过 `mchat/msg/req` 发送 `action: "auth.bind"`（payload 含 `employee_id` 或由服务端从凭证解析），服务端建立 client_id ↔ employee_id 映射并动态写入 Broker ACL。
- **主题 ACL 原则**（由服务端通过 Broker HTTP API 动态下发）：  
  - 客户端**仅允许发布**：`mchat/msg/req/{自身client_id}/+`、自身状态 `mchat/status/{自身employee_id}`、已读回执等约定主题。  
  - 客户端**仅允许订阅**：`mchat/msg/resp/{自身client_id}/+`、`mchat/inbox/{自身employee_id}`、已加入的 `mchat/group/{group_id}`、`mchat/profile/{自身employee_id}`、`mchat/system/notify` 等。  
  - 服务端：允许订阅 `mchat/msg/req/+/+`（及共享订阅），允许发布到各 resp、inbox、group、profile、system 等主题。
- **消息加密**：**不做端到端加密（E2EE）时**，消息的传输与存储由服务端/平台保护（TLS 传输、服务端落库加密或权限隔离）；若未来支持 E2EE，需单独约定密钥分发与 payload 加密方式。
- **审计**：所有管理指令与敏感操作留存审计日志（操作人/时间/内容）。
- **防滥用**：AI Agent 消息频率限流、内容敏感词过滤（服务端插件）。
- **敏感操作二次验证**：在纯 MQTT 下可通过「敏感 action 需先请求 `auth.challenge` 获取一次性 token，再在请求中携带该 token 执行实际操作」实现，具体 action 列表由实现定义。
- 满足等保基础要求及企业存档、离职数据迁移、水印溯源等刚需。

### 3.3 高可用与灾备

- MQTT Broker 集群 + 服务端多活部署
- 消息持久化至异地存储
- 无单点故障、故障自动转移（RTO &lt; 30s）
- 数据多地备份与定期恢复演练

### 3.4 可观测与弹性

- 全链路监控（消息轨迹追踪）、APM 性能分析、智能告警
- 弹性伸缩以应对流量洪峰，资源动态扩缩容

---

## 四、技术约束与选型建议

| 类别       | 建议 |
|------------|------|
| 协议       | **仅 MQTT**：消息与管理接口统一走 MQTT 主题与 payload，无额外业务协议；业务逻辑由服务端智能中枢弥补；便于在任意环境（PC/终端/服务器）部署客户端与服务端 |
| Broker     | EMQX Cloud / AWS IoT Core（ACL、共享订阅、持久化） |
| 消息存储   | 时序数据库（如 TDengine）用于消息持久化与检索 |
| 大文件     | OSS + MQTT 仅传加密元数据与临时链接；获取临时 URL 可通过 `mchat/msg/req` 的扩展 action（如 `file.upload_url` / `file.download_url`）请求-响应返回，保持纯 MQTT 交互 |

---

## 五、开发者支持（可选增强）

- 提供 Python/JS SDK：封装 MQTT 连接、消息编解码、重连逻辑
- 沙箱环境：测试 Agent 能力时隔离消息流
- 协议层扩展：如 `mchat/agent/capability/{skill}` 实现技能发现

---

## 六、功能优先级与 MVP 范围

### 6.1 MVP 必须包含

- 上述 **7 大核心功能** 全部实现
- **服务端**：员工/组织/权限/群组/组织结构管理，MQTT 网关、中继与状态中枢
- **客户端**：至少一种形态（如 SDK 或 Web），支持员工登录、单聊与群聊、接收管理通知
- AI Agent 员工模型、智能路由、基础人机协作（含转人工）
- 创建群聊、单聊与群聊消息收发、离线消息补推
- 最小管理集：成员与 Agent 管理、建群、审计日志
- 安全基线：TLS、认证鉴权、操作留痕

### 6.2 可延后（体验增强）

- 语音/视频/大文件传输、表情包、主题皮肤等
- 富媒体、已读回执、消息引用等可在首版后迭代

### 6.3 成熟度目标（中长期）

- **成熟 IM** = 可靠通信基座 × 企业治理深度 × 人性化体验 × 智能化扩展
- MChat 重点：数字员工身份管理、人机协作流设计、能力可发现性
- 目标：安全合规无死角、多端体验无割裂、企业治理无负担、人机协作无摩擦

---

## 七、文档与变更说明

- 本文档由 `.knowledge/讨论.md` 中的设计方案与「成熟 IM 能力」「核心功能点」讨论整理而成。
- 作为 MChat 产品需求与设计基线，后续详细设计（接口、数据模型、部署架构）应与此 PRD 对齐并保持更新。

**版本历史**

| 版本 | 说明 |
|------|------|
| 1.0  | 初版：产品目标、系统组成、7 大核心功能、主题体系、接口设计、非功能需求、MVP 范围 |
| 1.1  | 根据《产品需求方案-评审纪要》修订：① 明确管理类操作统一走 `mchat/msg/req`，`mchat/admin/cmd` 为预留/可选；② 新增「身份与连接模型」（client_id / employee_id、多端、订阅关系）；③ 新增「服务端订阅方式」与共享订阅建议；④ 新增「认证与 ACL」（登录、会话绑定、ACL 原则）、消息加密（非 E2EE 说明）及敏感操作二次验证思路；⑤ 新增「错误码与重试」约定；⑥ 新增「离线/历史消息」接口（msg.history_private、msg.history_group）；⑦ 新增消息 content 类型枚举（text/image/file）；⑧ 已读回执与 Agent 能力发现的主推方式与 topic 约定 |
