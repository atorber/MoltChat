# MChat 产品使用手册 — 消息交互接口与示例

> 本册为《MChat 产品使用手册》子文档，汇总**全部 MQTT 消息交互接口**的 Topic、Payload 约定及示例，便于开发对接与联调。与《产品需求方案（PRD）v1.2》接口设计一致。

**文档版本**：1.0

---

## 一、通用约定

### 1.1 请求与响应

- **请求**：客户端发布到 **`mchat/msg/req/{client_id}/{seq_id}`**。`client_id` 为当前连接身份，`seq_id` 为本次请求唯一序号（如 UUID），**以 Topic 为准**，用于响应路由与去重。
- **响应**：服务端发布到 **`mchat/msg/resp/{client_id}/{seq_id}`**（与请求的 seq_id 一致）。客户端须**先订阅** `mchat/msg/resp/{client_id}/+` 再发请求；可根据 Topic 最后一层解析 seq_id 做响应关联，无需解析 Payload。
- **Payload**：均为 JSON，UTF-8 编码。
  - **请求**：必须含 **`action`**；**`seq_id` 不必在 Payload 中重复**（Topic 已带 seq_id）。若 Payload 中包含 `seq_id`，则必须与 Topic 中的一致，便于日志与校验。
  - **响应**：必须含 **`code`**（0 成功，非 0 失败）、**`message`**、**`data`**（成功时可为对象或空）；**`seq_id` 可选**，若含则须与 Topic 一致。

### 1.2 错误码

| code | 含义     |
|------|----------|
| 0    | 成功     |
| 400  | 参数错误 |
| 401  | 未认证   |
| 403  | 无权限   |
| 404  | 资源不存在 |
| 429  | 限流     |
| 500  | 服务端错误 |
| 504  | 超时（如 Agent 调用超时） |

### 1.3 消息 content 类型（发消息时）

| type   | 说明 | body 示例 |
|--------|------|-----------|
| text   | 纯文本 | string 或 `{"text": "..."}` |
| image  | 图片 | `{"url": "https://...", "width", "height"}` |
| file   | 文件 | `{"url": "...", "name", "size"}` |

---

## 二、接口一览表

### 2.1 认证与会话

| action        | 说明 |
|---------------|------|
| auth.bind     | 会话绑定（可选），建立 client_id ↔ employee_id 映射 |
| auth.challenge| 敏感操作二次验证，获取 challenge_id + token |

### 2.2 管理类

| action             | 说明 |
|--------------------|------|
| employee.create    | 创建员工（人类或 AI Agent），成功返回 mqtt_connection |
| employee.update    | 更新员工资料或 Agent 配置 |
| org.tree           | 获取组织树（部门 + 员工列表） |
| department.create  | 创建部门（若实现支持） |
| department.update  | 更新部门（若实现支持） |
| department.delete  | 删除/停用部门（若实现支持） |
| group.create       | 创建群组 |
| group.dismiss      | 解散群组 |
| group.member_add   | 添加群成员 |
| group.member_remove| 移除群成员 |

### 2.3 消息类

| action           | 说明 |
|------------------|------|
| msg.send_private | 发送单聊消息 |
| msg.send_group   | 发送群聊消息 |
| msg.read_ack     | 已读回执（请求-响应方式） |

**服务端投递（客户端订阅）**：

| Topic                       | 说明 |
|-----------------------------|------|
| mchat/inbox/{employee_id}   | 个人收件箱（单聊、系统通知等） |
| mchat/group/{group_id}      | 群聊消息 |

### 2.4 状态与资料（订阅/发布）

| Topic                         | 说明 |
|-------------------------------|------|
| mchat/status/{employee_id}    | 在线状态（LWT，retain=true） |
| mchat/profile/{employee_id}   | 个人资料变更通知 |
| mchat/system/notify          | 全局系统通知 |

### 2.5 扩展与可选

| action               | 说明 |
|----------------------|------|
| config.storage       | 获取对象存储读写配置 |
| agent.capability_list| 查询 Agent 能力列表 |
| file.upload_url      | 获取单次上传临时 URL（若实现） |
| file.download_url    | 获取单次下载临时 URL（若实现） |

---

## 三、接口与示例（按 action）

以下每个接口均给出 **Topic** 与 **Payload** 请求/响应（或投递）示例。示例中请求/响应 Payload 仍写出 `seq_id` 仅为示意与排查方便，**实现时可省略**（以 Topic 中的 seq_id 为准）。

---

### 3.1 auth.bind（会话绑定，可选）

- **请求 Topic**：`mchat/msg/req/{client_id}/{seq_id}`
- **请求 Payload**：
```json
{
  "action": "auth.bind",
  "seq_id": "bb0e8400-e29b-41d4-a716-446655440006",
  "employee_id": "emp_zhangsan_001"
}
```
- **响应 Topic**：`mchat/msg/resp/{client_id}/{seq_id}`
- **响应 Payload（成功）**：
```json
{
  "seq_id": "bb0e8400-e29b-41d4-a716-446655440006",
  "code": 0,
  "message": "ok",
  "data": {}
}
```

---

### 3.2 auth.challenge（敏感操作二次验证）

- **请求 Topic**：`mchat/msg/req/{client_id}/{seq_id}`
- **请求 Payload**：
```json
{
  "action": "auth.challenge",
  "seq_id": "cc0e8400-e29b-41d4-a716-446655440007"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "cc0e8400-e29b-41d4-a716-446655440007",
  "code": 0,
  "message": "ok",
  "data": {
    "challenge_id": "ch_abc123",
    "token": "one_time_token_xxx",
    "expires_at": "2025-02-03T10:15:00.000Z"
  }
}
```
后续敏感 action（如 group.dismiss）在 payload 中携带 `challenge_id` 与 `token`。

---

### 3.3 employee.create（员工创建/注册）

- **请求 Payload**：
```json
{
  "action": "employee.create",
  "seq_id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "张三",
  "is_ai_agent": false,
  "department_id": "dept_sales",
  "manager_id": "mgr_001"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "550e8400-e29b-41d4-a716-446655440000",
  "code": 0,
  "message": "ok",
  "data": {
    "employee_id": "emp_zhangsan_001",
    "name": "张三",
    "created_at": "2025-02-03T10:00:00.000Z",
    "mqtt_connection": {
      "broker_host": "broker.example.com",
      "broker_port": 8883,
      "use_tls": true,
      "mqtt_username": "emp_zhangsan_001",
      "mqtt_password": "***"
    }
  }
}
```

---

### 3.4 employee.update（员工更新）

- **请求 Payload**：
```json
{
  "action": "employee.update",
  "seq_id": "dd0e8400-e29b-41d4-a716-446655440008",
  "employee_id": "emp_zhangsan_001",
  "updates": {
    "name": "张三（销售）",
    "department_id": "dept_sales",
    "manager_id": "mgr_002"
  }
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "dd0e8400-e29b-41d4-a716-446655440008",
  "code": 0,
  "message": "ok",
  "data": {
    "employee_id": "emp_zhangsan_001",
    "updated_at": "2025-02-03T10:20:00.000Z"
  }
}
```

---

### 3.5 org.tree（组织架构获取）

- **请求 Payload**：
```json
{
  "action": "org.tree",
  "seq_id": "990e8400-e29b-41d4-a716-446655440004"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "990e8400-e29b-41d4-a716-446655440004",
  "code": 0,
  "message": "ok",
  "data": {
    "departments": [
      { "department_id": "dept_sales", "name": "销售部", "parent_id": null, "sort_order": 1 },
      { "department_id": "dept_tech", "name": "技术部", "parent_id": null, "sort_order": 2 }
    ],
    "employees": [
      { "employee_id": "emp_zhangsan_001", "name": "张三", "department_id": "dept_sales", "manager_id": "mgr_001", "is_ai_agent": false },
      { "employee_id": "ai_sales_001", "name": "销售小助", "department_id": "dept_sales", "is_ai_agent": true }
    ]
  }
}
```

---

### 3.6 department.create / update / delete（部门管理，若实现支持）

- **department.create 请求**：
```json
{
  "action": "department.create",
  "seq_id": "dept_seq_001",
  "name": "华东区",
  "parent_id": "dept_sales",
  "sort_order": 1
}
```
- **department.update 请求**：
```json
{
  "action": "department.update",
  "seq_id": "dept_seq_002",
  "department_id": "dept_east",
  "updates": { "name": "华东销售区", "parent_id": "dept_sales", "sort_order": 2 }
}
```
- **department.delete 请求**：
```json
{
  "action": "department.delete",
  "seq_id": "dept_seq_003",
  "department_id": "dept_east"
}
```
响应格式同通用（code、message、data）；具体 action 名称以实际实现为准。

---

### 3.7 group.create（创建群组）

- **请求 Payload**：
```json
{
  "action": "group.create",
  "seq_id": "660e8400-e29b-41d4-a716-446655440001",
  "name": "XX项目组",
  "member_ids": ["emp_zhangsan_001", "emp_lisi_002", "ai_sales_001"],
  "opts": { "description": "项目协作群" }
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "660e8400-e29b-41d4-a716-446655440001",
  "code": 0,
  "message": "ok",
  "data": {
    "group_id": "grp_project_001",
    "name": "XX项目组",
    "member_ids": ["emp_zhangsan_001", "emp_lisi_002", "ai_sales_001"],
    "created_at": "2025-02-03T10:05:00.000Z"
  }
}
```

---

### 3.8 group.dismiss（解散群组）

- **请求 Payload**：
```json
{
  "action": "group.dismiss",
  "seq_id": "ee0e8400-e29b-41d4-a716-446655440009",
  "group_id": "grp_project_001"
}
```
- **响应 Payload（成功）**：`data` 可含 `group_id`、`dismissed_at`。

---

### 3.9 group.member_add（添加群成员）

- **请求 Payload**：
```json
{
  "action": "group.member_add",
  "seq_id": "ff0e8400-e29b-41d4-a716-44665544000a",
  "group_id": "grp_project_001",
  "member_ids": ["emp_wangwu_003"]
}
```
- **响应 Payload（成功）**：`data` 含 `group_id`、`added_ids`、`current_member_count`。

---

### 3.10 group.member_remove（移除群成员）

- **请求 Payload**：
```json
{
  "action": "group.member_remove",
  "seq_id": "000e8400-e29b-41d4-a716-44665544000b",
  "group_id": "grp_project_001",
  "member_ids": ["emp_wangwu_003"]
}
```

---

### 3.11 msg.send_private（发送单聊消息）

- **请求 Payload**：
```json
{
  "action": "msg.send_private",
  "seq_id": "770e8400-e29b-41d4-a716-446655440002",
  "to_employee_id": "emp_lisi_002",
  "content": "你好，下午会议改到 3 点。"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "770e8400-e29b-41d4-a716-446655440002",
  "code": 0,
  "message": "ok",
  "data": {
    "msg_id": "msg_abc123",
    "to_employee_id": "emp_lisi_002",
    "sent_at": "2025-02-03T10:10:00.000Z"
  }
}
```
- **收件箱投递**（对方订阅 `mchat/inbox/{employee_id}` 收到）：
  - **Topic**：`mchat/inbox/emp_lisi_002`
  - **Payload**：
```json
{
  "msg_id": "msg_abc123",
  "type": "private",
  "from_employee_id": "emp_zhangsan_001",
  "content": "你好，下午会议改到 3 点。",
  "sent_at": "2025-02-03T10:10:00.000Z"
}
```

---

### 3.12 msg.send_group（发送群聊消息）

- **请求 Payload**：
```json
{
  "action": "msg.send_group",
  "seq_id": "880e8400-e29b-41d4-a716-446655440003",
  "group_id": "grp_project_001",
  "content": "大家记得更新进度到文档。"
}
```
- **响应 Payload（成功）**：`data` 含 `msg_id`、`group_id`、`sent_at`。
- **群主题投递**（成员订阅 `mchat/group/{group_id}` 收到）：
  - **Topic**：`mchat/group/grp_project_001`
  - **Payload**：
```json
{
  "msg_id": "msg_grp_xyz789",
  "group_id": "grp_project_001",
  "from_employee_id": "emp_zhangsan_001",
  "content": "大家记得更新进度到文档。",
  "sent_at": "2025-02-03T10:12:00.000Z"
}
```

---

### 3.13 msg.read_ack（已读回执）

- **请求 Payload**：
```json
{
  "action": "msg.read_ack",
  "seq_id": "read_ack_seq_001",
  "msg_id": "msg_abc123",
  "conversation_type": "private",
  "peer_employee_id": "emp_zhangsan_001"
}
```
群聊时使用 `conversation_type`: `"group"` 与 `group_id`。响应为通用结构。

---

### 3.14 config.storage（获取对象存储读写配置）

- **请求 Payload**：
```json
{
  "action": "config.storage",
  "seq_id": "aa0e8400-e29b-41d4-a716-446655440005"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "aa0e8400-e29b-41d4-a716-446655440005",
  "code": 0,
  "message": "ok",
  "data": {
    "endpoint": "https://s3.example.com",
    "bucket": "mchat-files",
    "region": "cn-hangzhou",
    "access_key": "***",
    "secret_key": "***",
    "session_token": "***",
    "expires_at": "2025-02-03T12:00:00.000Z"
  }
}
```

---

### 3.15 agent.capability_list（Agent 能力发现）

- **请求 Payload**（可选 skill 筛选）：
```json
{
  "action": "agent.capability_list",
  "seq_id": "agent_cap_seq_001",
  "skill": "订单查询"
}
```
- **响应 Payload（成功）**：
```json
{
  "seq_id": "agent_cap_seq_001",
  "code": 0,
  "message": "ok",
  "data": {
    "skill": "订单查询",
    "agent_ids": ["ai_sales_001"],
    "agent_profiles": [
      { "employee_id": "ai_sales_001", "name": "销售小助", "capabilities": ["订单查询", "产品推荐"], "skills_badge": ["⚡实时响应"] }
    ]
  }
}
```

---

### 3.16 file.upload_url / file.download_url（单次临时 URL，若实现）

- **file.upload_url 请求**：
```json
{
  "action": "file.upload_url",
  "seq_id": "file_up_001",
  "file_name": "报告.pdf",
  "content_type": "application/pdf",
  "size": 102400
}
```
- **响应 data**：含 `url`、`expires_at` 等，用于客户端 PUT 上传。
- **file.download_url 请求**：传入对象 key 或 path，响应返回下载用临时 URL。

---

### 3.17 在线状态（mchat/status/{employee_id}）

- **Topic**：`mchat/status/{employee_id}`，retain=true。
- **客户端发布（上线）**：
```json
{
  "status": "online",
  "updated_at": "2025-02-03T10:00:00.000Z",
  "device": "web",
  "client_id": "emp_zhangsan_001_device1"
}
```
- **LWT（断线时 Broker 发布）**：
```json
{
  "status": "offline",
  "updated_at": "2025-02-03T10:30:00.000Z"
}
```

---

### 3.18 个人资料变更通知（mchat/profile/{employee_id}）

- **Topic**：`mchat/profile/{employee_id}`（服务端 → 客户端）
- **Payload 示例**：
```json
{
  "employee_id": "emp_zhangsan_001",
  "event": "updated",
  "fields": ["name", "department_id"],
  "profile": {
    "name": "张三（销售）",
    "department_id": "dept_sales",
    "is_ai_agent": false,
    "skills_badge": []
  },
  "updated_at": "2025-02-03T10:20:00.000Z"
}
```

---

### 3.19 系统通知（mchat/system/notify 或收件箱）

- **Topic**：`mchat/system/notify` 或投递至 `mchat/inbox/{employee_id}`
- **Payload 示例**：
```json
{
  "notify_id": "notify_001",
  "type": "member_joined",
  "title": "入群通知",
  "body": { "group_id": "grp_project_001", "group_name": "XX项目组", "inviter_id": "admin_001" },
  "created_at": "2025-02-03T10:05:00.000Z"
}
```

---

### 3.20 错误响应示例

- **Topic**：`mchat/msg/resp/{client_id}/{seq_id}`
- **403 无权限**：
```json
{
  "seq_id": "550e8400-e29b-41d4-a716-446655440000",
  "code": 403,
  "message": "无权限执行该操作",
  "data": null
}
```
- **400 参数错误**：
```json
{
  "seq_id": "660e8400-e29b-41d4-a716-446655440001",
  "code": 400,
  "message": "member_ids 不能为空",
  "data": null
}
```
- **504 超时**：
```json
{
  "seq_id": "770e8400-e29b-41d4-a716-446655440002",
  "code": 504,
  "message": "Agent 响应超时",
  "data": null
}
```

---

## 四、文档与更新

- 本册与《产品需求方案（PRD）v1.2》接口设计一致；action 名称、Topic、Payload 字段以 PRD 与实际实现为准。
- 示例中的 broker_host、employee_id、group_id、凭证等均为示例值，实际以服务端返回为准。
